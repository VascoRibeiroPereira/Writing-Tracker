<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Entre Sonhos — Writing Tracker</title>
  <style>
    :root{
      --bg:#0b0b0d;
      --panel:#111116;
      --panel2:#14141b;
      --text:#f2f2f3;
      --muted:#b8b8c2;
      --accent:#ff7a18;
      --good:#3ddc97;
      --bad:#ff5b5b;
      --warn:#ffcc66;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 500px at 20% -10%, rgba(255,122,24,.18), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(255,122,24,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1100px; margin:0 auto; padding:22px}
    header{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between;
      margin-bottom:18px;
    }
    h1{font-size:22px; margin:0}
    .sub{color:var(--muted); margin-top:6px; font-size:14px}
    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:16px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .card h2{font-size:16px; margin:0 0 10px 0}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    input, textarea{
      width:100%;
      background: var(--panel2);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:88px; resize:vertical}
    input:focus, textarea:focus{
      border-color: rgba(255,122,24,.55);
      box-shadow:0 0 0 3px rgba(255,122,24,.12);
    }
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .btns{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      appearance:none; border:0;
      background: rgba(255,255,255,.06);
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      border:1px solid rgba(255,255,255,.08);
      font-weight:600;
    }
    button:hover{background: rgba(255,255,255,.09)}
    .primary{background: rgba(255,122,24,.20); border-color: rgba(255,122,24,.35)}
    .primary:hover{background: rgba(255,122,24,.28)}
    .danger{background: rgba(255,91,91,.16); border-color: rgba(255,91,91,.30)}
    .danger:hover{background: rgba(255,91,91,.22)}
    .hint{
      color:var(--muted); font-size:12px;
      margin-top:10px; line-height:1.4;
    }
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px; margin-top:10px;
    }
    @media (max-width: 900px){
      .stats{grid-template-columns: repeat(2, 1fr)}
    }
    .stat{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding:10px 12px;
    }
    .stat .k{font-size:11px; color:var(--muted)}
    .stat .v{font-size:18px; font-weight:800; margin-top:4px}
    .brand{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-top:10px; padding-top:10px;
      border-top:1px solid rgba(255,255,255,.06);
      color:var(--muted); font-size:12px;
    }
    table{
      width:100%; border-collapse:collapse; margin-top:12px; font-size:13px;
      overflow:hidden; border-radius: 14px;
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      vertical-align:top;
    }
    th{
      color:var(--muted); font-weight:700;
      text-align:left; background: rgba(0,0,0,.20);
    }
    tr:hover td{background: rgba(255,255,255,.03); cursor:pointer}
    .pill{
      display:inline-block; padding:2px 8px;
      border-radius:999px; font-size:11px; font-weight:800;
      border:1px solid rgba(255,255,255,.10);
    }
    .ok{color:var(--good); border-color: rgba(61,220,151,.35); background: rgba(61,220,151,.08)}
    .miss{color:var(--warn); border-color: rgba(255,204,102,.35); background: rgba(255,204,102,.07)}
    .bad{color:var(--bad); border-color: rgba(255,91,91,.35); background: rgba(255,91,91,.07)}
    canvas{
      width:100%;
      height:320px;
      background: #000000;
      border:1px solid rgba(255,255,255,.06);
      border-radius: 16px;
      display:block;
    }
    .topline{
      display:flex; align-items:flex-end;
      justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .filemeta{color:var(--muted); font-size:12px}
    .small{font-size:12px; color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Entre Sonhos — Writing Tracker</h1>
        <div class="sub">Regista palavras por dia • objetivo flexível • gráfico + export/import JSON</div>
      </div>
      <div class="small">Marca: <strong>@blog_entre_sonhos</strong></div>
    </header>

    <div class="grid">
      <section class="card">
        <h2>Adicionar / editar entrada</h2>

        <label for="date">Data</label>
        <input id="date" type="date" />

        <div class="row">
          <div>
            <label for="words">Palavras escritas</label>
            <input id="words" type="number" min="0" step="1" placeholder="ex.: 850" />
          </div>
          <div>
            <label for="goal">Objetivo do dia</label>
            <input id="goal" type="number" min="0" step="1" placeholder="ex.: 1000" />
          </div>
        </div>

        <label for="note">Nota (opcional)</label>
        <textarea id="note" placeholder="Uma linha sobre como correu, o que mudas amanhã, etc."></textarea>

        <div class="btns">
          <button class="primary" id="saveBtn">Guardar entrada</button>
          <button id="clearBtn">Limpar</button>
          <button class="danger" id="deleteBtn">Apagar esta entrada</button>
        </div>

        <div class="btns" style="margin-top:10px">
          <button id="exportJsonBtn">Exportar JSON</button>
          <label style="margin:0; display:flex; align-items:center; gap:10px">
            <input id="importFile" type="file" accept="application/json" style="display:none" />
            <button id="importJsonBtn" type="button">Importar JSON</button>
          </label>
          <button id="exportPngBtn">Exportar gráfico (PNG)</button>
        </div>

        <div class="hint">
          Dica: usa <strong>Importar JSON</strong> para recuperar dados noutro dispositivo.
          O ficheiro é a “memória” da app.
        </div>

        <div class="stats">
          <div class="stat"><div class="k">Total</div><div class="v" id="totalOut">0</div></div>
          <div class="stat"><div class="k">Média / dia</div><div class="v" id="avgOut">0</div></div>
          <div class="stat"><div class="k">Dias registados</div><div class="v" id="daysOut">0</div></div>
          <div class="stat"><div class="k">% dias com objetivo</div><div class="v" id="goalPctOut">0%</div></div>
        </div>

        <div class="brand">
          <span>Entre Sonhos</span>
          <span class="filemeta">Ficheiro: <span id="fileNameOut">—</span></span>
        </div>
      </section>

      <section class="card">
        <div class="topline">
          <div>
            <h2 style="margin:0">Evolução</h2>
            <div class="small">Clique numa linha da tabela para carregar/editar essa entrada.</div>
          </div>
        </div>

        <div style="margin-top:12px">
          <canvas id="chart" width="1200" height="600"></canvas>
        </div>

        <div style="overflow:auto; margin-top:10px">
          <table>
            <thead>
              <tr>
                <th style="min-width:110px">Data</th>
                <th style="min-width:90px">Palavras</th>
                <th style="min-width:90px">Objetivo</th>
                <th style="min-width:110px">Estado</th>
                <th>Nota</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // ---------- Estado ----------
      var entries = {}; // { 'YYYY-MM-DD': {words: number, goal: number|null, note: string} }
      var loadedFileName = "—";

      // ---------- Util ----------
      function $(id){ return document.getElementById(id); }

      var dateEl = $("date");
      var wordsEl = $("words");
      var goalEl  = $("goal");
      var noteEl  = $("note");

      var saveBtn   = $("saveBtn");
      var clearBtn  = $("clearBtn");
      var deleteBtn = $("deleteBtn");

      var exportJsonBtn = $("exportJsonBtn");
      var importJsonBtn = $("importJsonBtn");
      var importFile    = $("importFile");
      var exportPngBtn  = $("exportPngBtn");

      var totalOut   = $("totalOut");
      var avgOut     = $("avgOut");
      var daysOut    = $("daysOut");
      var goalPctOut = $("goalPctOut");
      var fileNameOut= $("fileNameOut");

      var tbody  = $("tbody");
      var canvas = $("chart");
      var ctx    = canvas.getContext("2d");

      function todayISO(){
        var d = new Date();
        var y = d.getFullYear();
        var m = String(d.getMonth()+1).padStart(2,"0");
        var da= String(d.getDate()).padStart(2,"0");
        return y + "-" + m + "-" + da;
      }

      function sortDates(a,b){ return a < b ? -1 : a > b ? 1 : 0; }

      function fmtNum(n){
        if (!isFinite(n)) return "0";
        return n.toLocaleString("pt-PT");
      }

      function safeInt(value){
        var n = Number(value);
        if (!isFinite(n) || n < 0) return 0;
        return Math.floor(n);
      }

      function downloadBlob(blob, filename){
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }

      function currentFormKey(){
        return (dateEl.value || "").trim();
      }

      function clearForm(){
        dateEl.value = todayISO();
        wordsEl.value = "";
        goalEl.value  = "";
        noteEl.value  = "";
        render();
      }

      function loadToForm(dateKey){
        var e = entries[dateKey];
        if (!e) return;
        dateEl.value = dateKey;
        wordsEl.value = String(e.words || 0);
        if (e.goal === null || e.goal === undefined) goalEl.value = "";
        else goalEl.value = String(e.goal);
        noteEl.value = e.note || "";
      }

      // ---------- Core ----------
      function saveEntry(){
        var k = currentFormKey();
        if (!k){
          alert("Escolhe uma data.");
          return;
        }

        var words = safeInt(wordsEl.value);
        var goalRaw = (goalEl.value || "").trim();
        var goal = goalRaw === "" ? null : safeInt(goalRaw);
        var note = (noteEl.value || "").trim();

        entries[k] = {
          words: words,
          goal: goal,
          note: note
        };

        render();
        loadToForm(k);
      }

      function deleteEntry(){
        var k = currentFormKey();
        if (!k) return;
        if (!entries[k]){
          alert("Não existe entrada para esta data.");
          return;
        }
        if (!confirm("Apagar a entrada de " + k + "?")) return;

        delete entries[k];
        clearForm();
        render();
      }

      function computeStats(){
        var keys = Object.keys(entries).sort(sortDates);
        var days = keys.length;
        var total = 0;
        var goalDays = 0;

        for (var i=0;i<keys.length;i++){
          var e = entries[keys[i]];
          var w = safeInt(e.words);
          total += w;
          if (e.goal !== null && e.goal !== undefined) goalDays++;
        }

        var avg = days ? Math.round(total / days) : 0;
        var goalPct = days ? Math.round((goalDays / days) * 100) : 0;

        totalOut.textContent = fmtNum(total);
        avgOut.textContent   = fmtNum(avg);
        daysOut.textContent  = fmtNum(days);
        goalPctOut.textContent = goalPct + "%";
        fileNameOut.textContent = loadedFileName || "—";

        return keys;
      }

      function escapeHtml(str){
        return String(str)
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;")
          .replace(/'/g,"&#039;");
      }

      function statusPill(words, goal){
        if (goal === null || goal === undefined){
          return '<span class="pill miss">sem objetivo</span>';
        }
        if (goal === 0 || words >= goal){
          return '<span class="pill ok">cumprido</span>';
        }
        var pct = Math.round((words / goal) * 100);
        return '<span class="pill bad">' + pct + '%</span>';
      }

      function renderTable(keys){
        tbody.innerHTML = "";
        for (var i=0;i<keys.length;i++){
          var k = keys[i];
          var e = entries[k];
          var words = safeInt(e.words);
          var goal = (e.goal === null || e.goal === undefined) ? null : safeInt(e.goal);
          var note = (e.note || "").trim();

          var tr = document.createElement("tr");
          tr.innerHTML =
            "<td>" + k + "</td>" +
            "<td>" + fmtNum(words) + "</td>" +
            "<td>" + (goal === null ? "—" : fmtNum(goal)) + "</td>" +
            "<td>" + statusPill(words, goal) + "</td>" +
            "<td>" + escapeHtml(note) + "</td>";

          (function(dateKey){
            tr.addEventListener("click", function(){
              loadToForm(dateKey);
            });
          })(k);

          tbody.appendChild(tr);
        }
      }

      function renderChart(keys){
        var W = canvas.width;
        var H = canvas.height;
        ctx.clearRect(0,0,W,H);

        // fundo sólido preto
        ctx.save();
        ctx.fillStyle = "#000000";
        ctx.fillRect(0,0,W,H);
        ctx.restore();

        var padL = 70, padR = 20, padT = 24, padB = 70;
        var plotW = W - padL - padR;
        var plotH = H - padT - padB;

        // grelha
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,0.08)";
        ctx.lineWidth = 1;
        var gridY = 5;
        for (var i=0;i<=gridY;i++){
          var gy = padT + (plotH * i / gridY);
          ctx.beginPath();
          ctx.moveTo(padL, gy);
          ctx.lineTo(W - padR, gy);
          ctx.stroke();
        }
        ctx.restore();

        var wordsSeries = [];
        var goalSeries = [];
        var iKey;
        for (iKey=0;iKey<keys.length;iKey++){
          var e = entries[keys[iKey]];
          wordsSeries.push(safeInt(e.words));
          if (e.goal === null || e.goal === undefined) goalSeries.push(null);
          else goalSeries.push(safeInt(e.goal));
        }

        var maxVal = 10;
        for (iKey=0;iKey<wordsSeries.length;iKey++){
          if (wordsSeries[iKey] > maxVal) maxVal = wordsSeries[iKey];
        }
        for (iKey=0;iKey<goalSeries.length;iKey++){
          if (goalSeries[iKey] !== null && goalSeries[iKey] > maxVal) maxVal = goalSeries[iKey];
        }

        // eixos
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,0.18)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(padL, padT);
        ctx.lineTo(padL, H - padB);
        ctx.lineTo(W - padR, H - padB);
        ctx.stroke();
        ctx.restore();

        // labels Y
        ctx.save();
        ctx.fillStyle = "rgba(255,255,255,0.70)";
        ctx.font = "18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.textAlign = "right";
        ctx.textBaseline = "middle";
        for (iKey=0;iKey<=gridY;iKey++){
          var val = Math.round(maxVal * (1 - iKey / gridY));
          var yLabel = padT + (plotH * iKey / gridY);
          ctx.fillText(String(val), padL - 10, yLabel);
        }
        ctx.restore();

        if (keys.length === 0){
          ctx.save();
          ctx.fillStyle = "rgba(255,255,255,0.55)";
          ctx.font = "26px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("Sem dados — adiciona uma entrada para veres o gráfico.", W/2, H/2);
          ctx.restore();

          // mesmo sem dados, watermark
          ctx.save();
          ctx.fillStyle = "rgba(255,255,255,0.65)";
          ctx.font = "16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.textAlign = "right";
          ctx.textBaseline = "bottom";
          ctx.fillText("@blog_entre_sonhos", W - 16, H - 12);
          ctx.restore();
          return;
        }

        function xAt(i){
          if (keys.length === 1) return padL + plotW/2;
          return padL + (plotW * i / (keys.length - 1));
        }
        function yAt(v){
          var t = v / maxVal;
          return padT + (plotH * (1 - t));
        }

        // linha de palavras (laranja)
        ctx.save();
        ctx.strokeStyle = "rgba(255,122,24,0.95)";
        ctx.lineWidth = 4;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
        ctx.beginPath();
        for (iKey=0;iKey<keys.length;iKey++){
          var x = xAt(iKey);
          var y = yAt(wordsSeries[iKey]);
          if (iKey === 0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
        ctx.restore();

        // linha de objetivo (segmentos brancos)
        ctx.save();
        ctx.strokeStyle = "rgba(255,255,255,0.60)";
        ctx.lineWidth = 3;
        for (iKey=0;iKey<keys.length-1;iKey++){
          var g1 = goalSeries[iKey];
          var g2 = goalSeries[iKey+1];
          if (g1 === null || g2 === null) continue;
          var x1 = xAt(iKey),   y1 = yAt(g1);
          var x2 = xAt(iKey+1), y2 = yAt(g2);

          var steps = 10;
          for (var s=0;s<steps;s++){
            if (s % 2 === 1) continue;
            var t1 = s/steps;
            var t2 = (s+1)/steps;
            ctx.beginPath();
            ctx.moveTo(x1 + (x2-x1)*t1, y1 + (y2-y1)*t1);
            ctx.lineTo(x1 + (x2-x1)*t2, y1 + (y2-y1)*t2);
            ctx.stroke();
          }
        }
        ctx.restore();

        // pontos
        ctx.save();
        for (iKey=0;iKey<keys.length;iKey++){
          x = xAt(iKey);
          y = yAt(wordsSeries[iKey]);
          ctx.fillStyle = "rgba(255,122,24,1)";
          ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fill();
          ctx.fillStyle = "rgba(0,0,0,0.65)";
          ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
        }
        ctx.restore();

        // labels X (primeira e última data)
        ctx.save();
        ctx.fillStyle = "rgba(255,255,255,0.70)";
        ctx.font = "18px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "top";
        var first = keys[0];
        var last  = keys[keys.length-1];
        ctx.fillText(first, xAt(0), H - padB + 18);
        if (keys.length > 1){
          ctx.fillText(last, xAt(keys.length-1), H - padB + 18);
        }

        // legenda
        ctx.textAlign = "left";
        ctx.textBaseline = "alphabetic";
        ctx.fillStyle = "rgba(255,122,24,0.95)";
        ctx.fillText("Palavras", padL, padT - 6);
        ctx.fillStyle = "rgba(255,255,255,0.70)";
        ctx.fillText("Objetivo", padL + 120, padT - 6);

        // watermark @blog_entre_sonhos
        ctx.textAlign = "right";
        ctx.textBaseline = "bottom";
        ctx.fillStyle = "rgba(255,255,255,0.65)";
        ctx.font = "16px syste
